#!@@PERL@@ -T
package Munin::Master::Http;

use strict;
use warnings;

use HTTP::Server::Simple::CGI;
use base qw(HTTP::Server::Simple::CGI);

use Munin::Master::Graph;
use Munin::Master::HTML;

my @times = qw(day week month year);
# Current incarnation of $cgi.
# XXX - this is NOT thread-safe!
my $cgi;

sub handle_request
{
	my $self = shift;
	$cgi = shift;

	my $path = $cgi->path_info();

	# Dispatch by extension, so we can have the same URL prefix
	my ($ext) = ($path =~ m/.*\.([^.]+)$/);
	if (Munin::Master::Graph::is_ext_handled($ext)) {
		Munin::Master::Graph::handle_request($cgi);
	} else {
		Munin::Master::HTML::handle_request($cgi);
	}	
}

package main;

# start the server on port 4948
Munin::Master::Http->new(4948)->run();
