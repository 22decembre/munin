#!/bin/bash

: << =cut

=head1 NAME

jenkins_builds_results_summary - Plugin to measure results of all jenkins builds

=head1 CONFIGURATION

[jenkins_builds]
env.jenkins_update_interval 15

jenkins_update_interval: minimum number of minutes between successive
    update operations (adjust according to your resource limits)
    Default: 15

=head1 AUTHOR

Contributed by Holger Levsen. I wrote and used them first for
https://jenkins.debian.net and very much like to hear about
other users of these plugins! Please do tell me!

Use at your own risk and monitor the resource usage of the plugins
too - it will vary depending on your setup!

Patches, postcards and pancakes are all very much welcome!

=head1 LICENSE

Copyright 2012-2014 Holger Levsen <holger@layer-acht.org>

Released under the GPLv2.

=head1 MAGIC MARKERS

 #%# family=auto
 #%# capabilities=autoconf

=cut

# shellcheck disable=SC1090
. "$MUNIN_LIBDIR/plugins/plugin.sh"

jenkins_update_interval=${jenkins_update_interval:-15}

if [ "${1:-}" = "autoconf" ]; then
	if [ -d /var/lib/jenkins/jobs ]; then
		echo yes
	else
		echo "no (/var/lib/jenkins/jobs not found)"
	fi
	exit 0
fi

STATEFILE=$MUNIN_PLUGSTATE/$(basename "$0")

# delete statefile if it's older than ${jenkins_update_interval} set in /etc/munin/plugin-conf.d/jenkins
find "$STATEFILE" -maxdepth 0 -mmin "+$jenkins_update_interval" -delete 2>&1 || true

if [ -f "$STATEFILE" ] && [ -z "${1:-}" ] ; then
	cat "$STATEFILE"
	exit 0
fi

if [ "${1:-}" = "config" ]; then
	echo 'graph_title Jenkins Builds results summary'
	echo 'graph_args --base 1000 -l 0 '
	echo 'graph_scale no'
	echo 'graph_total total'
	echo 'graph_vlabel Jenkins Builds results summary'
	echo 'graph_category devel'
	for STATE in success unstable failure ; do
		echo "jenkins_builds_results_all_${STATE}.label ${PREFIX} ${STATE}"
		echo "jenkins_builds_results_all_${STATE}.draw AREASTACK"
	done
	exit 0
fi

RESULTS=$(for i in /var/lib/jenkins/jobs/*/builds/*_*/log; do tail -1 "$i" 2>/dev/null; echo; done)
for STATE in success unstable failure ; do
	NR=0
	if [ "$STATE" = "failure" ] ; then
		# count aborted as failed
		NR=$(echo -e "$RESULTS" | grep -E -i -c "($STATE|aborted)")
	else
		NR=$(echo -e "$RESULTS" | grep -i -c "$STATE")
	fi
	echo "jenkins_builds_results_all_${STATE}.value $NR" | tee -a "$STATEFILE"
done
